<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <script>
        var carPic = document.createElement("img");
        var carPicLoaded = false;

        var carX = 75;
        var carY = 75;
        var carAng = 0;
        var carSpeedX = 5;
        var carSpeedY = 7;

        const TRACK_WIDTH = 40;
        const TRACK_HEIGHT = 40; 
        const TRACK_GAP = 2;
        const TRACK_COLS = 20;
        const TRACK_ROWS = 15; 
        var trackGrid = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                         1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
                         1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
                         1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
                         1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
                         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,];

        var canvas, canvasContext; 

        var mouseX = 0;
        var mouseY = 0;

        window.onload = function() {
            canvas = document.getElementById("gameCanvas");
            canvasContext = canvas.getContext("2d");

            var framesPerSecond = 30;
            setInterval(updateAll, 1000/framesPerSecond);

            canvas.addEventListener("mousemove", updateMousePos);
            
            carPic.onload = function () {
                carPicLoaded = true;
            }
            carPic.src = "player1car.png";
        
            carReset();
        }

        function updateMousePos(evt) {
            var rect = canvas.getBoundingClientRect();
            var root = document.documentElement;

            mouseX = evt.clientX - rect.left
            mouseY = evt.clientY - rect.top

            /*// cheat to test car in any position
            carX = mouseX;
            carY = mouseY;
            carSpeedX = 3;
            carSpeedY = -4;
            */
        }

        function updateAll() {
            moveAll();
            drawAll();
        }

        function carReset() {
            for (var eachRow=0;eachRow<TRACK_ROWS;eachRow++) {
                for (var eachCol=0;eachCol<TRACK_COLS;eachCol++) {
                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);
                    if (trackGrid[arrayIndex] == 2) {
                        trackGrid[arrayIndex] = 0;
                        carX = eachCol * TRACK_WIDTH;
                        carY = eachRow * TRACK_HEIGHT;
                    } // end of if car found
                } // end of search columns
            } // end of search rows
        } // end of carReset func

        function carMove() {
            // carX += carSpeedX;
            // carY += carSpeedY;
            carAng += 0.02;

            if (carX > canvas.width && // right
                carSpeedX > 0.0) { // bugfixing corner catch
                carSpeedX *= -1;
            }
            if (carX < 0 && // left
                carSpeedX < 0.0) { // bugfixing corner catch
                carSpeedX *= -1;
            }
            if(carY > canvas.height) { // bottom
                carReset();
            }
            if (carY < 0 && // top
                carSpeedY < 0.0) { // bugfixing corner catch
                carSpeedY *= -1;
            }
        }

        function carTrackHandling() {
            var carTrackCol = Math.floor(carX / TRACK_WIDTH);
            var carTrackRow = Math.floor(carY / TRACK_HEIGHT);
            var trackIndexUnderCar = rowColToArrayIndex(carTrackCol,carTrackRow)
            
            // test its a legal track
            if (carTrackCol >= 0 &&
                carTrackCol < TRACK_COLS &&
                carTrackRow >= 0 &&
                carTrackRow < TRACK_ROWS) {

                // test track collision
                if (isTrackAtColRow(carTrackCol, carTrackRow)) {

                    // test collision direction
                    var prevCarX = carX - carSpeedX;
                    var prevCarY = carY - carSpeedY;
                    var prevTrackCol = Math.floor(prevCarX / TRACK_WIDTH);
                    var prevTrackRow = Math.floor(prevCarY / TRACK_HEIGHT);

                    var bothTestsFailed = true;

                    // horizontal collision
                    if (carTrackCol != prevTrackCol) {
                        // bugfixing if tracks beside collision are blocking side edge
                        if (isTrackAtColRow(prevTrackCol, carTrackRow) == false) {
                            carSpeedX *= -1;
                            bothTestsFailed = false;
                        }
                    }

                    // vertical collision
                    if (carTrackRow != prevTrackRow) { 
                        // bugfixing if tracks above/below are blocking top/bottom edge
                        if (isTrackAtColRow(carTrackCol, prevTrackRow) == false) {
                            carSpeedY *= -1;
                            bothTestsFailed = false;
                        }
                    }

                    // bugfixing if both edges are blocked by tracks.
                    if (bothTestsFailed) {
                        carSpeedX *= -1;
                        carSpeedY *= -1;
                    } // end of bugfixing if both edges are blocked by tracks.
                } // of track collision found
            } // end of valid col and row
        } // end of carTrackHandling func


        function moveAll() {
            carMove();
            carTrackHandling();
        }

        function drawTracks() {
            for (var eachRow=0;eachRow<TRACK_ROWS;eachRow++) {
                for (var eachCol=0;eachCol<TRACK_COLS;eachCol++) {

                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);

                    if (trackGrid[arrayIndex] == 1) {
                        colorRect(TRACK_WIDTH*eachCol,
                                  TRACK_HEIGHT*eachRow,
                                  TRACK_WIDTH-TRACK_GAP,
                                  TRACK_HEIGHT-TRACK_GAP,
                                  'blue');
                    } // end of is this track here
                } // end of for each track
            } // end of for each row
        } // end of drawTracks func

        function drawAll() {
            colorRect(0,0,canvas.width,canvas.height, "black"); // Blank canvas

            // colorCircle(carX,carY,10, "white"); // Draw car
            if (carPicLoaded) {
                drawBitmapCenteredWithRotation(carPic, carX, carY, carAng);
            }
            drawTracks();
        }


        // **********************************
        //  Helper functions

        function drawBitmapCenteredWithRotation(useBitmap, atX, atY, withAng) {
            canvasContext.save();
            canvasContext.translate(atX, atY);
            canvasContext.rotate(withAng);
            canvasContext.drawImage(useBitmap, -useBitmap.width/2, -useBitmap.height/2);
            canvasContext.restore();
        }

        function colorRect(topLeftX,topLeftY,boxWidth,boxHeight,fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillRect(topLeftX,topLeftY,boxWidth,boxHeight);
        }

        function colorCircle(centerX,centerY,radius, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.beginPath();
            canvasContext.arc(centerX,centerY,radius,0,Math.PI*2,true);
            canvasContext.fill();
        }

        function colorText(showWords, textX,textY, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillText(showWords, textX,textY);
        }

        function rowColToArrayIndex(col, row) {
            return col + (TRACK_COLS * row);
        }

        function isTrackAtColRow (col, row) {
            // test its a legal track
            if (col >= 0 &&
                col < TRACK_COLS &&
                row >= 0 &&
                row < TRACK_ROWS) {

                var trackIndexUnderCoord = rowColToArrayIndex(col,row)
                return (trackGrid[trackIndexUnderCoord] == 1);
            } else {
                return false;
            }
        }




    </script>
</body>
</html>