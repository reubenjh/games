<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <script>
        var carPic = document.createElement("img");
        var carPicLoaded = false;

        var carX = 75;
        var carY = 75;
        var carAng = 0;
        var carSpeed = 0;

        const GROUNDSPEED_DECAY_MULT = 0.96;
        const DRIVE_POWER = 0.5;
        const REVERSE_POWER = 0.2;
        const TURN_RATE = 0.07;

        const TRACK_WIDTH = 40;
        const TRACK_HEIGHT = 40; 
        const TRACK_GAP = 2;
        const TRACK_COLS = 20;
        const TRACK_ROWS = 15; 
        var trackGrid = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                         1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
                         1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
                         1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
                         1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
                         1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
                         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,];
        const TRACK_ROAD = 0;
        const TRACK_WALL = 1;
        const TRACK_PLAYERSTART = 2;

        var canvas, canvasContext;

        const KEY_LEFT_ARROW = 37;
        const KEY_UP_ARROW = 38;
        const KEY_RIGHT_ARROW = 39;
        const KEY_DOWN_ARROW = 40;

        var keyHeldGas = false;
        var keyHeldReverse = false;
        var keyHeldTurnLeft = false;
        var keyHeldTurnRight = false;

        var mouseX = 0;
        var mouseY = 0;


        function updateMousePos(evt) {
            var rect = canvas.getBoundingClientRect();
            var root = document.documentElement;

            mouseX = evt.clientX - rect.left
            mouseY = evt.clientY - rect.top

            /*// cheat to test car in any position
            carX = mouseX;
            carY = mouseY;
            carSpeedX = 3;
            carSpeedY = -4;
            */
        }

        function keyPressed(evt) {
            //console.log(evt.keyCode);
            if (evt.keyCode == KEY_LEFT_ARROW) {
                keyHeldTurnLeft = true;
            }
            if (evt.keyCode == KEY_RIGHT_ARROW) {
                keyHeldTurnRight = true;
            }
            if (evt.keyCode == KEY_UP_ARROW) {
                keyHeldGas = true;
            }
            if (evt.keyCode == KEY_DOWN_ARROW) {
                keyHeldReverse = true;
            }
            evt.preventDefault();
        }

        function keyReleased(evt) {
            //console.log(evt.keyCode);
            if (evt.keyCode == KEY_LEFT_ARROW) {
                keyHeldTurnLeft = false;
            }
            if (evt.keyCode == KEY_RIGHT_ARROW) {
                keyHeldTurnRight = false;
            }
            if (evt.keyCode == KEY_UP_ARROW) {
                keyHeldGas = false;
            }
            if (evt.keyCode == KEY_DOWN_ARROW) {
                keyHeldReverse = false;
            }
            evt.preventDefault();
        }

        window.onload = function() {
            canvas = document.getElementById("gameCanvas");
            canvasContext = canvas.getContext("2d");

            var framesPerSecond = 30;
            setInterval(updateAll, 1000/framesPerSecond);

            canvas.addEventListener("mousemove", updateMousePos);

            document.addEventListener("keydown", keyPressed);
            document.addEventListener("keyup", keyReleased);
            
            carPic.onload = function () {
                carPicLoaded = true;
            }
            carPic.src = "player1car.png";
        
            carReset();
        }


        function updateAll() {
            moveAll();
            drawAll();
        }

        function carReset() {
            for (var eachRow=0;eachRow<TRACK_ROWS;eachRow++) {
                for (var eachCol=0;eachCol<TRACK_COLS;eachCol++) {
                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);
                    if (trackGrid[arrayIndex] == TRACK_PLAYERSTART) {
                        trackGrid[arrayIndex] = TRACK_ROAD;
                        carAng = -Math.PI/2;
                        carX = eachCol * TRACK_WIDTH;
                        carY = eachRow * TRACK_HEIGHT;
                    } // end of if car found
                } // end of search columns
            } // end of search rows
        } // end of carReset func

        function carMove() {
            carSpeed *= GROUNDSPEED_DECAY_MULT; // Handling natural deceleration

            if (keyHeldGas) { // Accelerate
                carSpeed += DRIVE_POWER;
            }
            if (keyHeldReverse) { // Brake
                carSpeed -= REVERSE_POWER;
            }
            if (keyHeldTurnRight) { // Turn right
                carAng += TURN_RATE;
            }
            if (keyHeldTurnLeft) { // Turn left
                carAng -= TURN_RATE;
            }

            // Account for angle
            carX += Math.cos(carAng) * carSpeed;
            carY += Math.sin(carAng) * carSpeed;
        }

        function carTrackHandling() {
            var carTrackCol = Math.floor(carX / TRACK_WIDTH);
            var carTrackRow = Math.floor(carY / TRACK_HEIGHT);
            var trackIndexUnderCar = rowColToArrayIndex(carTrackCol,carTrackRow)
            
            // test its a legal track
            if (carTrackCol >= 0 &&
                carTrackCol < TRACK_COLS &&
                carTrackRow >= 0 &&
                carTrackRow < TRACK_ROWS) {

                // test track collision
                if (isWallAtColRow(carTrackCol, carTrackRow)) {
                    // Undoes car movement that gets it stuck inside wall
                    carX -= Math.cos(carAng) * carSpeed;
                    carY -= Math.sin(carAng) * carSpeed;
                    
                    carSpeed *= -0.5;
                } // of track collision found
            } // end of valid col and row
        } // end of carTrackHandling func


        function moveAll() {
            carMove();
            carTrackHandling();
        }

        function drawTracks() {
            for (var eachRow=0;eachRow<TRACK_ROWS;eachRow++) {
                for (var eachCol=0;eachCol<TRACK_COLS;eachCol++) {

                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);

                    if (trackGrid[arrayIndex] == TRACK_WALL) {
                        colorRect(TRACK_WIDTH*eachCol,
                                  TRACK_HEIGHT*eachRow,
                                  TRACK_WIDTH-TRACK_GAP,
                                  TRACK_HEIGHT-TRACK_GAP,
                                  'blue');
                    } // end of is this track here
                } // end of for each track
            } // end of for each row
        } // end of drawTracks func

        function drawAll() {
            colorRect(0,0,canvas.width,canvas.height, "black"); // Blank canvas

            // colorCircle(carX,carY,10, "white"); // Draw car
            if (carPicLoaded) {
                drawBitmapCenteredWithRotation(carPic, carX, carY, carAng);
            }
            drawTracks();
        }


        // **********************************
        //  Helper functions

        function drawBitmapCenteredWithRotation(useBitmap, atX, atY, withAng) {
            canvasContext.save();
            canvasContext.translate(atX, atY);
            canvasContext.rotate(withAng);
            canvasContext.drawImage(useBitmap, -useBitmap.width/2, -useBitmap.height/2);
            canvasContext.restore();
        }

        function colorRect(topLeftX,topLeftY,boxWidth,boxHeight,fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillRect(topLeftX,topLeftY,boxWidth,boxHeight);
        }

        function colorCircle(centerX,centerY,radius, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.beginPath();
            canvasContext.arc(centerX,centerY,radius,0,Math.PI*2,true);
            canvasContext.fill();
        }

        function colorText(showWords, textX,textY, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillText(showWords, textX,textY);
        }

        function rowColToArrayIndex(col, row) {
            return col + (TRACK_COLS * row);
        }

        function isWallAtColRow (col, row) {
            // test its a legal track
            if (col >= 0 &&
                col < TRACK_COLS &&
                row >= 0 &&
                row < TRACK_ROWS) {

                var trackIndexUnderCoord = rowColToArrayIndex(col,row)
                return (trackGrid[trackIndexUnderCoord] == TRACK_WALL);
            } else {
                return false;
            }
        }

    </script>
</body>
</html>